<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VAIDYA — Accessible healthcare</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark">

  <!-- Fonts (system fallback, but with nicer weight) -->
  <style>
    :root{
      --bg: #f4f7fb;
      --card: #ffffff;
      --primary: #1565c0;
      --primary-600: #0f52a3;
      --muted: #6b7280;
      --accent: #00b894;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.6);
      --radius: 12px;
      --shadow-1: 0 6px 18px rgba(10,20,40,0.06);
      --shadow-2: 0 10px 30px rgba(10,20,40,0.08);
      --max-width: 1100px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #eef5ff 0%, var(--bg) 100%);
      color: #0f1724;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.4;
    }

    /* Header */
    header {
      background: linear-gradient(90deg,var(--primary),var(--primary-600));
      color: white;
      padding: 18px 28px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow: var(--shadow-1);
      position:sticky;
      top:0;
      z-index:40;
    }
    .brand { display:flex; align-items:center; gap:12px; font-weight:700; font-size:18px; }
    .brand .logo {
      width:40px; height:40px; border-radius:10px;
      display:grid; place-items:center; background:rgba(255,255,255,0.12);
      box-shadow: inset 0 -6px 18px rgba(0,0,0,0.06);
      font-weight:800;
    }
    nav { display:flex; align-items:center; gap:10px; }

    /* Container */
    .wrap { max-width:var(--max-width); margin:26px auto; padding:0 20px; }

    /* Main grid */
    .grid {
      display:grid;
      grid-template-columns: 1fr 380px;
      gap:22px;
      align-items:start;
    }
    @media (max-width:980px){ .grid{grid-template-columns:1fr;} .side{order:2} }

    /* Cards */
    .card {
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow-1);
      border:1px solid rgba(15,23,36,0.04);
    }
    .h-lg { font-size:20px; margin:0 0 10px; font-weight:600; }
    p.muted { color:var(--muted); margin:0 0 12px; }

    /* Form inputs */
    .form-row { display:flex; gap:12px; margin-bottom:12px; }
    .form-row .field { flex:1; min-width:0; display:flex; flex-direction:column; }
    label.small { font-size:12px; color:var(--muted); margin-bottom:6px; }
    input[type="text"],input[type="email"],input[type="password"],select,textarea{
      padding:12px 14px;
      border-radius:10px;
      border:1px solid rgba(15,23,36,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,250,0.9));
      outline:none;
      font-size:14px;
      transition:box-shadow .18s, border-color .18s, transform .09s;
    }
    input:focus, textarea:focus {
      box-shadow: 0 6px 24px rgba(21,101,192,0.08);
      border-color: var(--primary-600);
      transform:translateY(-1px);
    }
    .btn {
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:600;
      color:white;
      background:linear-gradient(90deg,var(--primary-600),var(--primary));
      box-shadow: 0 8px 24px rgba(21,101,192,0.12);
      transition:transform .12s, box-shadow .12s;
    }
    .btn:active{ transform:translateY(1px); }
    .btn.ghost {
      background: transparent; color: var(--primary-600); border:1px solid rgba(21,101,192,0.12);
      box-shadow:none;
    }
    .btn.flat { background:var(--accent); box-shadow:none; color:white; }

    /* Right side */
    .side .small-card { margin-bottom:14px; }

    /* Doctors list */
    .doctor-row { display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; border:1px solid rgba(15,23,36,0.04);}
    .doctor-row .meta { flex:1; }
    .slot { display:inline-block; padding:6px 8px; background:#eef7ff; color:var(--primary-600); border-radius:8px; margin:6px 6px 0 0; font-size:13px; cursor:pointer; }

    /* AI result */
    #aiResult { margin-top:12px; background:linear-gradient(180deg,#ffffff,#fcfdff); padding:12px; border-radius:10px; border:1px solid rgba(15,23,36,0.04); }

    /* Professional Login Modal */
    .auth-modal {
      position:fixed; inset:0; display:grid; place-items:center; z-index:200;
      background: linear-gradient(180deg, rgba(7,12,24,0.45), rgba(7,12,24,0.6));
      padding:20px;
      visibility:hidden; opacity:0; transition:opacity .18s, visibility .18s;
    }
    .auth-modal.show { visibility:visible; opacity:1; }
    .auth-card {
      width:100%; max-width:920px; display:grid; grid-template-columns: 1fr 380px; gap:20px;
      background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,250,0.98));
      border-radius:16px; padding:20px; box-shadow:var(--shadow-2);
    }
    .auth-left { padding:10px 6px; }
    .auth-brand { display:flex; gap:12px; align-items:center; margin-bottom:6px; }
    .auth-desc { color:var(--muted); margin-bottom:16px; font-size:14px; }
    .tabs { display:flex; gap:8px; margin-bottom:12px; }
    .tab { padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; color:var(--muted); background:transparent; border:1px solid transparent; }
    .tab.active { background: linear-gradient(90deg,var(--primary-600),var(--primary)); color:white; box-shadow:0 8px 24px rgba(21,101,192,0.12); }
    .auth-right { padding:18px; border-radius:12px; background:linear-gradient(180deg,#fff,#fbfdff); border:1px solid rgba(10,20,40,0.04); display:flex; flex-direction:column; justify-content:center; }

    .small-note{ font-size:13px; color:var(--muted) }
    .muted-sm { font-size:13px; color:var(--muted) }

    /* Footer mini */
    footer.small { text-align:center; padding:26px 10px; color:var(--muted); font-size:13px; }

    /* Responsive */
    @media (max-width:980px) {
      .auth-card{ grid-template-columns: 1fr; padding:14px; }
      .auth-modal{ padding:12px; }
    }
  </style>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden>V</div>
      <div>
        <div style="font-size:15px">VAIDYA</div>
        <div style="font-size:12px;color:rgba(255,255,255,0.85);font-weight:500">Accessible healthcare</div>
      </div>
    </div>
    <nav id="nav">
      <button id="openAuth" class="btn ghost" title="Sign in">Sign in</button>
    </nav>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Left: main content -->
      <section class="card">
        <h2 class="h-lg">Patient Dashboard</h2>
        <p class="muted">Describe symptoms and get AI suggestions. This is a demo — always consult a qualified clinician for diagnosis and treatment.</p>

        <div class="form-row" style="align-items:center;">
          <div class="field" style="flex:1;">
            <label class="small">Describe your symptoms</label>
            <input id="symptomsInput" placeholder="e.g. fever, sore throat, headache" />
          </div>
          <div style="display:flex;align-items:center;">
            <button id="askAiBtn" class="btn">Get Suggestions (AI)</button>
          </div>
        </div>

        <div id="aiResult" style="display:none"></div>

        <hr style="border:none;border-top:1px solid rgba(15,23,36,0.04);margin:18px 0;">

        <h3 style="margin:0 0 10px">Nearby pharmacies</h3>
        <div class="card" id="map" style="height:320px;display:flex;align-items:center;justify-content:center;color:var(--muted)">Map will load after allowing location and replacing the Google Maps API key.</div>
      </section>

      <!-- Right: doctors list / quick actions -->
      <aside class="side">
        <div class="card small-card">
          <h4 style="margin:0 0 8px">Find a doctor</h4>
          <p class="muted-sm">Verified doctors near you (demo). Book directly from the list.</p>
        </div>

        <div class="card small-card">
          <h4 style="margin:0 0 8px">Top specialties</h4>
          <div style="display:flex;flex-wrap:wrap;gap:8px">
            <span class="slot">General Physician</span>
            <span class="slot">ENT</span>
            <span class="slot">Pediatrics</span>
            <span class="slot">Dermatology</span>
          </div>
        </div>

        <div class="card small-card">
          <h4 style="margin:0 0 8px">Verified Doctors</h4>
          <div id="doctorsContainer" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="small">Built with ❤️ • Demo VAIDYA project</footer>

  <!-- AUTH MODAL -->
  <div id="authModal" class="auth-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="auth-card card" role="document" aria-labelledby="authTitle">
      <div class="auth-left">
        <div class="auth-brand">
          <div class="logo" style="width:56px;height:56px;border-radius:12px">V</div>
          <div>
            <div id="authTitle" style="font-size:18px;font-weight:700">VAIDYA</div>
            <div class="auth-desc">Secure sign in for patients & doctors — access your dashboard and history.</div>
          </div>
        </div>

        <div class="tabs" role="tablist" aria-label="Authentication Tabs">
          <button id="tabSignIn" class="tab active" role="tab" aria-selected="true">Sign in</button>
          <button id="tabSignUp" class="tab" role="tab" aria-selected="false">Register</button>
        </div>

        <!-- Sign in form -->
        <form id="loginForm" novalidate>
          <div class="form-row">
            <div class="field"><label class="small">Email</label><input id="loginEmail" type="email" required placeholder="you@domain.com" /></div>
          </div>
          <div class="form-row">
            <div class="field"><label class="small">Password</label>
              <div style="display:flex;gap:8px">
                <input id="loginPassword" type="password" required placeholder="Your password" />
                <button id="toggleLoginPass" type="button" class="btn ghost" style="padding:8px 10px">Show</button>
              </div>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <button id="submitLogin" class="btn" type="submit">Sign in</button>
            <button id="closeAuth" type="button" class="btn ghost">Close</button>
          </div>

          <p class="small-note" style="margin-top:14px">Forgot password? Use the Register form to re-create your access (demo). For production add a reset flow.</p>
        </form>
      </div>

      <div class="auth-right">
        <div style="margin-bottom:12px">
          <h3 style="margin:0 0 8px">Create an account</h3>
          <p class="muted-sm">Register as a patient or a doctor to access role-based dashboards.</p>
        </div>

        <form id="registerForm" novalidate>
          <div class="form-row">
            <div class="field"><label class="small">Email</label><input id="regEmail" type="email" placeholder="you@domain.com" required /></div>
          </div>
          <div class="form-row">
            <div class="field"><label class="small">Phone</label><input id="regPhone" type="text" placeholder="+91 9xxxxxxxxx" /></div>
            <div class="field"><label class="small">Role</label>
              <select id="regRole">
                <option value="patient">Patient</option>
                <option value="doctor">Doctor</option>
              </select>
            </div>
          </div>
          <div class="form-row" style="align-items:center">
            <div class="field"><label class="small">Password</label><input id="regPassword" type="password" placeholder="Choose a secure password" required /></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="submitRegister" type="submit" class="btn flat">Create account</button>
            <button id="demoFill" type="button" class="btn ghost">Fill demo</button>
          </div>

          <p style="margin-top:12px" class="small-note">By creating an account you agree to the demo terms. This is a demo site — do not use real PHI here.</p>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase + App logic -->
  <script>
    // ---------- CONFIG: Replace these with your Firebase project keys ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD9x8Y39gxGewZAFXl7DKKKMP7Q7tAsTgg",
      authDomain: "vaidya-ca935.firebaseapp.com",
      projectId: "vaidya-ca935",
      storageBucket: "vaidya-ca935.appspot.com",
      messagingSenderId: "612534206422",
      appId: "1:612534206422:web:325e6af9bc30aa358cae77",
      measurementId: "G-RJVYKP6ZDM"
    };

    // Your serverless function base (Netlify or Firebase)
    const CF_BASE = "/.netlify/functions"; // or replace with your cloud function URL

    // Replace with your Google Maps key if you want the map to load
    const GOOGLE_MAPS_KEY = "REPLACE_GOOGLE_MAPS_KEY";

    // Initialize Firebase
    try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase init failed:", e); alert("Firebase initialization failed. Check console."); }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- UI helpers ---
    const $ = (id) => document.getElementById(id);
    const authModal = $('authModal');
    const openAuth = $('openAuth');
    const closeAuth = $('closeAuth');
    const tabSignIn = $('tabSignIn');
    const tabSignUp = $('tabSignUp');
    const loginForm = $('loginForm');
    const registerForm = $('registerForm');

    function showAuth(openTab = 'login') {
      authModal.classList.add('show');
      authModal.setAttribute('aria-hidden','false');
      if (openTab === 'login') activateTab('login'); else activateTab('register');
    }
    function hideAuth(){
      authModal.classList.remove('show');
      authModal.setAttribute('aria-hidden','true');
    }
    function activateTab(name){
      if (name === 'login') {
        tabSignIn.classList.add('active'); tabSignIn.setAttribute('aria-selected','true');
        tabSignUp.classList.remove('active'); tabSignUp.setAttribute('aria-selected','false');
        loginForm.style.display = ''; registerForm.style.display = 'none';
      } else {
        tabSignUp.classList.add('active'); tabSignUp.setAttribute('aria-selected','true');
        tabSignIn.classList.remove('active'); tabSignIn.setAttribute('aria-selected','false');
        loginForm.style.display = 'none'; registerForm.style.display = '';
      }
    }

    // attach open/close
    openAuth.addEventListener('click', () => showAuth('login'));
    closeAuth.addEventListener('click', hideAuth);
    tabSignIn.addEventListener('click', () => activateTab('login'));
    tabSignUp.addEventListener('click', () => activateTab('register'));

    // toggle password visibility
    $('#toggleLoginPass').addEventListener('click', () => {
      const el = $('loginPassword'); el.type = (el.type === 'password') ? 'text' : 'password';
      $('#toggleLoginPass').textContent = (el.type === 'password') ? 'Show' : 'Hide';
    });

    // demo fill
    $('#demoFill').addEventListener('click', () => {
      $('regEmail').value = 'demo+' + Math.floor(Math.random()*9999) + '@example.com';
      $('regPhone').value = '91' + (Math.floor(Math.random()*900000000)+100000000);
      $('regPassword').value = 'Demo1234!';
    });

    // --- Auth logic (register/login) ---
    // Register
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('regEmail').value.trim();
      const pass = $('regPassword').value;
      const phone = $('regPhone').value.trim();
      const role = $('regRole').value || 'patient';
      if (!email || !pass) return alert('Email and password required.');
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, pass);
        await cred.user.updateProfile({ displayName: email.split('@')[0] });
        // Save to Firestore
        await db.collection('users').doc(cred.user.uid).set({
          displayName: cred.user.displayName || '',
          email, phone, role, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('Account created & signed in.');
        hideAuth();
      } catch (err) {
        console.error('Register error',err);
        alert('Register error: ' + (err.message || err));
      }
    });

    // Login
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = $('loginEmail').value.trim();
      const pass = $('loginPassword').value;
      if (!email || !pass) return alert('Enter email and password.');
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        alert('Login successful');
        hideAuth();
      } catch (err) {
        console.error('Login error',err);
        alert('Login error: ' + (err.message || err));
      }
    });

    // --- Main app pieces (preserve your original functionality) ---
    const navEl = $('nav');
    const mainApp = document.querySelector('main');
    const aiResultEl = $('aiResult');
    const symptomsInput = $('symptomsInput');
    const askAiBtn = $('askAiBtn');
    const doctorsContainer = $('doctorsContainer');

    function show(el){ if(el) el.style.display = ''; }
    function hide(el){ if(el) el.style.display = 'none'; }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // show sign-in button
        navEl.innerHTML = `<button id="openAuth" class="btn ghost">Sign in</button>`;
        $('openAuth').addEventListener('click', ()=>showAuth('login'));
        // hide dashboards (we keep patient UI visible but not interactive)
        hide(aiResultEl); return;
      }
      // load profile
      let profile = { role:'patient', displayName: user.email.split('@')[0] };
      try {
        const udoc = await db.collection('users').doc(user.uid).get();
        if (udoc.exists) profile = { ...profile, ...udoc.data() };
      } catch (e) { console.warn(e); }

      navEl.innerHTML = `<span style="color:white;margin-right:12px">Hi ${profile.displayName || user.email}</span><button id="logoutBtn" class="btn ghost">Logout</button>`;
      $('logoutBtn').addEventListener('click', async () => { await auth.signOut(); location.reload(); });
      // show main interactive UI
      // (We keep everything visible on the page — you can customize role-based views)
      loadDoctorsList();
      // init map only when logged in (optional)
      initMap();
    });

    // AI request (calls CF_BASE + /ai-suggest)
    askAiBtn.addEventListener('click', async () => {
      const raw = (symptomsInput.value || '').trim();
      if (!raw) return alert('Please enter symptoms.');
      const symptoms = raw.split(',').map(s => s.trim()).filter(Boolean);
      aiResultEl.style.display = '';
      aiResultEl.textContent = 'Thinking...';
      try {
        // Using public function for demo (no token). If your function requires token, attach it.
        const resp = await fetch(`${CF_BASE}/ai-suggest`, {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ symptoms })
        });
        if (!resp.ok) {
          const t = await resp.text();
          console.error('AI error:', resp.status, t);
          aiResultEl.textContent = 'AI request failed: ' + (t.slice ? t.slice(0,300) : t);
          return;
        }
        const json = await resp.json();
        aiResultEl.innerHTML = `<strong>AI Suggestions</strong><div style="margin-top:8px"><pre>${json.aiText || 'No response'}</pre></div>`;
      } catch (err) {
        console.error(err);
        aiResultEl.textContent = 'AI request failed: ' + (err.message || err);
      }
    });

    // Doctors: load demo or real list from Firestore
    async function loadDoctorsList() {
      try {
        const snap = await db.collection('doctors').where('verified','==',true).limit(10).get();
        if (snap.empty) {
          doctorsContainer.innerHTML = `<div class="muted-sm">No verified doctors yet in demo. You can seed some in Firestore.</div>`;
          return;
        }
        doctorsContainer.innerHTML = snap.docs.map(d => {
          const data = d.data();
          return `<div class="doctor-row">
            <div class="meta">
              <div style="font-weight:700">${data.name || 'Doctor'}</div>
              <div style="font-size:13px;color:var(--muted)">${data.specialty || 'General'}</div>
              <div style="font-size:13px;color:var(--muted)">${data.phone || ''}</div>
            </div>
            <div>
              <button class="btn ghost" onclick="bookDoctor('${d.id}')">Book</button>
            </div>
          </div>`;
        }).join('');
      } catch (e) {
        console.warn('loadDoctorsList', e);
        doctorsContainer.innerHTML = `<div class="muted-sm">Failed to load doctors.</div>`;
      }
    }

    window.bookDoctor = async (docId) => {
      const user = auth.currentUser;
      if (!user) return showAuth('login');
      try {
        // Simple booking: write booking with earliest slot if available
        const dsnap = await db.collection('doctors').doc(docId).get();
        const doc = dsnap.data();
        if(!doc || !doc.slots) return alert('No slots available.');
        const date = Object.keys(doc.slots)[0], time = doc.slots[date][0];
        if (!time) return alert('No slots.');
        await db.runTransaction(async (tx) => {
          const dref = db.collection('doctors').doc(docId);
          const ddoc = await tx.get(dref);
          const slots = ddoc.data().slots || {};
          const daySlots = slots[date] || [];
          const newDaySlots = daySlots.filter(s => s !== time);
          slots[date] = newDaySlots;
          tx.update(dref, { slots });
          const bookingRef = db.collection('bookings').doc();
          tx.set(bookingRef, {
            userId: user.uid, doctorId: docId, date, time, status: 'booked',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        alert('Booked ' + date + ' ' + time);
        loadDoctorsList();
      } catch (e) { console.error(e); alert('Booking failed: ' + (e.message || e)); }
    };

    // Map initialization (requires key)
    function initMap() {
      if (!GOOGLE_MAPS_KEY || GOOGLE_MAPS_KEY === 'REPLACE_GOOGLE_MAPS_KEY') {
        console.warn('Google Maps key not set; skipping map load.');
        return;
      }
      if (window.google && window.google.maps) return initMapOnce();
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_KEY}&libraries=places&callback=initMapOnce`;
      s.async = true; s.defer = true;
      document.head.appendChild(s);
    }
    window.initMapOnce = async function() {
      const mapEl = $('map');
      mapEl.innerHTML = '';
      try {
        const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(p => res(p.coords), rej));
        const center = { lat: pos.latitude, lng: pos.longitude };
        const map = new google.maps.Map(mapEl, { center, zoom: 13 });
        new google.maps.Marker({ position: center, map, title: 'You are here' });
        const service = new google.maps.places.PlacesService(map);
        service.nearbySearch({ location: center, radius: 3000, type: ['pharmacy'] }, (results, status) => {
          if (status !== google.maps.places.PlacesServiceStatus.OK) return;
          results.forEach(place => {
            const marker = new google.maps.Marker({ position: place.geometry.location, map, title: place.name });
            const infow = new google.maps.InfoWindow({ content: `<strong>${place.name}</strong><div style="font-size:13px">${place.vicinity}</div>` });
            marker.addListener('click', () => infow.open(map, marker));
          });
        });
      } catch (err) {
        mapEl.innerText = 'Could not load location. Allow location permission or try later.';
      }
    };

    // hide auth modal when clicking outside card
    authModal.addEventListener('click', (e) => {
      if (e.target === authModal) hideAuth();
    });

    // Keyboard accessibility (Esc to close)
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideAuth(); });

    // Open modal automatically if not logged in (optional)
    // if (!auth.currentUser) showAuth('login');

    // initial tab states
    activateTab('login');
  </script>
</body>
</html>
