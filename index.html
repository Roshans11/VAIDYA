<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VAIDYA - Demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
   /* ----------------- GLOBAL STYLES ------------------ */
body {
  font-family: "Inter", system-ui, Arial;
  margin: 0;
  background: linear-gradient(135deg, #e3f2fd 0%, #fdfdfd 100%);
  color: #222;
}

header {
  background: linear-gradient(90deg, #1565c0, #0d47a1);
  color: white;
  padding: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 4px 14px rgba(0,0,0,0.15);
  font-size: 18px;
  font-weight: 600;
}

/* Center container */
.container {
  padding: 20px;
  max-width: 1100px;
  margin: 0 auto;
}

/* Beautiful card */
.card {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(8px);
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.07);
  margin-bottom: 22px;
  border: 1px solid rgba(255,255,255,0.4);
}

/* Inputs */
input, select, textarea {
  padding: 12px;
  width: 100%;
  border-radius: 10px;
  border: 1px solid #cbd5e1;
  font-size: 14px;
  transition: 0.2s;
}

input:focus, select:focus {
  border-color: #1565c0;
  box-shadow: 0 0 6px rgba(21,101,192,0.4);
  outline: none;
}

/* Buttons */
button {
  padding: 10px 16px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
}

#registerBtn, #loginBtn, #askAiBtn, #saveSlotsBtn {
  background: #1565c0;
  color: white;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(21,101,192,0.3);
}

/* Login section modern look */
#authArea {
  max-width: 520px;
  margin: 40px auto;
  text-align: center;
}

#authArea h3 {
  font-size: 22px;
  margin-bottom: 20px;
}

/* Dashboard titles */
#patientDashboard h3,
#doctorDashboard h3 {
  font-weight: 700;
  font-size: 22px;
  margin-bottom: 14px;
}

/* Doctor Cards */
.doctor {
  padding: 12px;
  border-radius: 10px;
  background: #f5f9ff;
  border-left: 5px solid #1565c0;
  margin-bottom: 15px;
}

.doctor strong {
  font-size: 17px;
}

/* AI result box */
#aiResult {
  background: #e8f3ff;
  border-left: 4px solid #1565c0;
  padding: 12px;
  border-radius: 8px;
}

/* Flex */
.flex {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

/* Map */
.map {
  border-radius: 12px;
  min-height: 260px;
}

/* Verified Doctors Section */
#doctorsList h3 {
  font-size: 20px;
  margin-bottom: 10px;
}

nav button {
  background: transparent;
  color: white;
  border: 1px solid rgba(255,255,255,0.4);
  padding: 8px 12px;
  border-radius: 8px;
}

nav button:hover {
  background: rgba(255,255,255,0.2);
}

/* small adjustments for list items appended by JS */
#pharmList .doctor { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px; }

/* avatar in nav */
#navAvatar { width:36px; height:36px; border-radius:50%; object-fit:cover; border:2px solid rgba(255,255,255,0.12); }

/* profile header in dashboard */
#profileHeader { display:flex; align-items:center; gap:14px; margin-bottom:12px; }
#profileAvatar { width:72px; height:72px; border-radius:12px; object-fit:cover; border:2px solid rgba(0,0,0,0.06); }
  </style>

  <!-- Firebase SDKs (compat for simple examples) -->
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-storage-compat.js"></script>

</head>
<body>
  <header>
    <div><strong>VAIDYA</strong> — Accessible healthcare</div>
    <nav id="nav"></nav>
  </header>

  <div class="container">
    <!-- AUTH / REGISTER -->
    <div id="authArea" class="card">
      <h3>Welcome to VAIDYA</h3>
      <p style="color:#555;margin-top:-10px;margin-bottom:18px;">
        Sign in or create an account to continue
      </p>

      <div style="display:flex; flex-direction:column; gap:12px; align-items:stretch;">
        <input id="email" placeholder="Email address" />
        <input id="phone" placeholder="Phone number" />
        <select id="role">
          <option value="patient">Patient</option>
          <option value="doctor">Doctor</option>
        </select>

        <!-- profile photo optional -->
        <label style="font-size:13px;color:#555;margin:0 2px;">Profile photo (optional)</label>
        <input id="photoInput" type="file" accept="image/*" />

        <input id="password" type="password" placeholder="Password" />
        <div style="display:flex; gap:10px; margin-top:6px;">
          <button id="loginBtn" style="flex:1;">Login</button>
          <button id="registerBtn" style="flex:1;background:#0b8b53;">Register</button>
        </div>
      </div>

      <p style="margin-top:12px;color:#555;font-size:13px;">Note: Make sure Email/Password sign-in is enabled in Firebase Console.</p>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display:none">
      <!-- PATIENT DASHBOARD -->
      <div id="patientDashboard" class="card" style="display:none">
        <!-- profile header -->
        <div id="profileHeader" style="display:none;">
          <img id="profileAvatar" src="" alt="avatar"/>
          <div>
            <div id="profileName" style="font-weight:700;font-size:18px;">User</div>
            <div id="profileRole" style="font-size:13px;color:#666;">Patient</div>
          </div>
        </div>

        <h3>Patient Dashboard</h3>

        <p style="color:#444;margin-top:-10px;">
          Describe your symptoms and get instant smart suggestions.
        </p>

        <div style="display:flex; gap:12px; margin-top:14px;">
          <input id="symptomsInput" placeholder="e.g. fever, cough, headache" style="flex:1;">
          <button id="askAiBtn">Ask AI</button>
        </div>

        <div id="aiResult" class="card" style="display:none;margin-top:20px;"></div>

        <h4 style="margin-top:18px">Nearby pharmacies</h4>
        <div id="map" class="map card">Map will load after you allow location (and replace the Google Maps API key).</div>
        <div id="pharmList"></div>
      </div>

      <!-- DOCTOR DASHBOARD -->
      <div id="doctorDashboard" class="card" style="display:none">
        <h3>Doctor Dashboard</h3>

        <p style="color:#444;margin-top:-10px;">
          Update your available consultation slots.
        </p>

        <div style="display:flex; gap:12px; margin-top:14px;">
          <input id="slotsInput" placeholder="2025-11-20:10:00,10:30,11:00" style="flex:1;">
          <button id="saveSlotsBtn">Save</button>
        </div>

        <h4 style="margin-top:20px;">Your bookings</h4>
        <div id="doctorBookings"></div>
      </div>
    </div>

    <!-- DOCTORS LIST -->
    <div id="doctorsList" class="card" style="display:none">
      <h3>Verified Doctors</h3>
      <div id="doctorsContainer"></div>
    </div>
  </div>

  <script>
    // ---------- CONFIG: Replace these with your Firebase project keys ----------
    const firebaseConfig = {
      apiKey: "AIzaSyD9x8Y39gxGewZAFXl7DKKKMP7Q7tAsTgg",
      authDomain: "vaidya-ca935.firebaseapp.com",
      projectId: "vaidya-ca935",
      storageBucket: "vaidya-ca935.appspot.com",
      messagingSenderId: "612534206422",
      appId: "1:612534206422:web:325e6af9bc30aa358cae77",
      measurementId: "G-RJVYKP6ZDM"
    };

    // Your serverless function base (Netlify or Firebase)
    const CF_BASE = "/.netlify/functions";

    // Google Maps key — set to your key to load live map.
    const GOOGLE_MAPS_KEY = "REPLACE_GOOGLE_MAPS_KEY";

    // Initialize Firebase
    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error("Firebase init failed:", e); alert("Firebase init failed - check console"); }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // UI refs
    const $ = id => document.getElementById(id);
    const registerBtn = $('registerBtn');
    const loginBtn = $('loginBtn');
    const nav = $('nav');
    const authArea = $('authArea');
    const mainApp = $('mainApp');
    const patientDash = $('patientDashboard');
    const doctorDash = $('doctorDashboard');
    const doctorsList = $('doctorsList');
    const doctorsContainer = $('doctorsContainer');
    const aiResultEl = $('aiResult');
    const profileHeader = $('profileHeader');
    const profileAvatar = $('profileAvatar');
    const profileName = $('profileName');
    const profileRole = $('profileRole');

    const show = el => { if (el) el.style.display = ''; }
    const hide = el => { if (el) el.style.display = 'none'; }

    // Prevent default if buttons in forms
    [registerBtn, loginBtn].forEach(b => { if (b) b && b.addEventListener) b.addEventListener('click', e => e.preventDefault()); });

    // ---------- Register flow (upload profile photo + save user doc) ----------
    if (registerBtn) {
      registerBtn.addEventListener('click', async () => {
        const email = ($('email')?.value || '').trim();
        const password = ($('password')?.value || '').trim();
        const phone = ($('phone')?.value || '').trim();
        const role = ($('role')?.value || 'patient');
        if (!email || !password) return alert("Email and password required for registration.");

        try {
          const cred = await auth.createUserWithEmailAndPassword(email, password);
          const displayName = email.split('@')[0];
          // set displayName initially
          await cred.user.updateProfile({ displayName });

          // optional photo upload
          const photoInput = $('photoInput');
          let photoURL = '';
          if (photoInput && photoInput.files && photoInput.files[0]) {
            try {
              const file = photoInput.files[0];
              const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
              const filename = `profiles/${cred.user.uid}/avatar_${Date.now()}.${ext}`;
              const ref = storage.ref().child(filename);
              const uploadSnap = await ref.put(file);
              photoURL = await uploadSnap.ref.getDownloadURL();
              // update auth profile with photoURL
              await cred.user.updateProfile({ photoURL });
            } catch (upErr) {
              console.warn("Photo upload failed:", upErr);
              // continue registration without blocking
            }
          }

          // Save user doc with photoURL if present
          await db.collection('users').doc(cred.user.uid).set({
            displayName: displayName,
            email,
            phone,
            role,
            photoURL: photoURL || '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          alert("Registered and signed in.");
        } catch (err) {
          console.error("Register error:", err);
          alert("Register error: " + (err.message || err));
        }
      });
    }

    // ---------- Login flow ----------
    if (loginBtn) {
      loginBtn.addEventListener('click', async () => {
        const email = ($('email')?.value || '').trim();
        const password = ($('password')?.value || '').trim();
        if (!email || !password) return alert("Enter email and password to login.");

        try {
          const cred = await auth.signInWithEmailAndPassword(email, password);
          console.log("Logged in:", cred.user.uid);
          alert("Login successful.");
        } catch (err) {
          console.error("Login error:", err);
          alert("Login error: " + (err.message || err));
        }
      });
    }

    // ---------- Observe auth state ----------
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        show(authArea);
        hide(mainApp);
        nav.innerHTML = '';
        hide(doctorsList);
        // clear profile header
        if (profileHeader) profileHeader.style.display = 'none';
        return;
      }

      // fetch user doc
      let profile = { role: 'patient', displayName: user.email?.split('@')[0] || '' };
      try {
        const udoc = await db.collection('users').doc(user.uid).get();
        if (udoc.exists) profile = { ...profile, ...udoc.data() };
      } catch (e) {
        console.warn("Could not load user doc:", e);
      }

      // determine avatar/url and display name
      const avatarUrl = profile.photoURL || profile.photo || user.photoURL || '';
      const safeName = (profile.displayName || user.displayName || user.email?.split('@')[0] || 'User');

      // render nav with avatar + name + logout
      nav.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;">
          <img id="navAvatar" src="${avatarUrl || 'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22 viewBox=%220 0 24 24%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22 fill=%22%231565c0%22/><text x=%2250%25%22 y=%2258%25%22 font-size=%2211%22 fill=%22white%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22>${encodeURIComponent(safeName.charAt(0).toUpperCase())}</text></svg>'}" alt="avatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.12)" />
          <span style="color:white;font-weight:600">${safeName}</span>
          <button id="logoutBtn" style="margin-left:12px;background:transparent;border:1px solid rgba(255,255,255,0.18);color:white;padding:8px 10px;border-radius:8px;cursor:pointer">Logout</button>
        </div>
      `;
      // attach logout handler safely
      const lb = document.getElementById('logoutBtn');
      if (lb) lb.addEventListener('click', async () => { await auth.signOut(); location.reload(); });

      // update dashboard profile header
      if (profileHeader) {
        if (profileAvatar) profileAvatar.src = avatarUrl || '';
        if (profileName) profileName.textContent = safeName;
        if (profileRole) profileRole.textContent = profile.role ? (profile.role.charAt(0).toUpperCase() + profile.role.slice(1)) : '';
        profileHeader.style.display = '';
      }

      hide(authArea);
      show(mainApp);

      if (profile.role === 'patient') {
        show(patientDash); hide(doctorDash); show(doctorsList);
      } else if (profile.role === 'doctor') {
        hide(patientDash); show(doctorDash); hide(doctorsList);
        loadDoctorBookings(user.uid).catch(e => console.warn(e));
      } else {
        show(patientDash);
      }

      loadDoctorsList().catch(e => console.warn(e));
      initMap(); // map will show demo if key not set
    });

    window.logout = async () => { try { await auth.signOut(); location.reload(); } catch (e) { console.warn(e); } };

    // ---------- AI Request ----------
    const askAiBtn = $('askAiBtn');
    if (askAiBtn) {
      askAiBtn.addEventListener('click', async () => {
        const raw = ($('symptomsInput')?.value || '').trim();
        if (!raw) return alert("Enter symptoms");
        const symptoms = raw.split(',').map(s=>s.trim()).filter(Boolean);
        try {
          const idToken = await auth.currentUser.getIdToken(true);
          aiResultEl.style.display = '';
          aiResultEl.innerText = 'Thinking...';

          const r = await fetch(`${CF_BASE}/ai-suggest`, {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + idToken },
            body: JSON.stringify({ symptoms })
          });

          if (!r.ok) {
            const text = await r.text();
            console.error("AI request failed:", r.status, text);
            throw new Error(text || "AI request failed");
          }

          const json = await r.json();
          if (json.error) throw new Error(json.error);
          aiResultEl.innerHTML = `<h4>AI Suggestions</h4><pre>${json.aiText || JSON.stringify(json, null, 2)}</pre>`;

          if (json.relatedDoctors && json.relatedDoctors.length) {
            const html = json.relatedDoctors.map(d=>`
              <div class="doctor">
                <strong>${d.name}</strong> — ${d.specialty || 'N/A'} <br/>
                Phone: ${d.phone || 'N/A'} <br/>
                <button onclick='bookDoctor("${d.id}")'>Book</button>
              </div>`).join('');
            aiResultEl.innerHTML += `<h4>Related doctors</h4>${html}`;
          }
        } catch (err) {
          console.error(err);
          alert("AI error: " + (err.message || err));
        }
      });
    }

    // ---------- Doctors list & booking ----------
    async function loadDoctorsList() {
      try {
        const snap = await db.collection('doctors').where('verified','==',true).limit(50).get();
        const html = snap.docs.map(d=> {
          const data = d.data();
          return `<div class="doctor card">
            <strong>${data.name || 'Unnamed'}</strong> — ${data.specialty || ''}<br/>Phone: ${data.phone || ''}<br/>
            <button onclick='bookDoctor("${d.id}")'>Book</button>
          </div>`;
        }).join('');
        doctorsContainer.innerHTML = html || '<p>No verified doctors yet.</p>';
        show(doctorsList);
      } catch (e) {
        console.warn("loadDoctorsList error:", e);
      }
    }

    window.bookDoctor = async (docId) => {
      const user = auth.currentUser;
      if (!user) return alert("Login first");
      try {
        const docSnap = await db.collection('doctors').doc(docId).get();
        const doc = docSnap.data();
        if (!doc || !doc.slots) return alert("No slots available");
        let date = Object.keys(doc.slots)[0];
        let time = doc.slots[date][0];
        if (!date || !time) return alert("No slots");
        await db.runTransaction(async (tx) => {
          const dref = db.collection('doctors').doc(docId);
          const ddoc = await tx.get(dref);
          const slots = ddoc.data().slots || {};
          const daySlots = slots[date];
          if (!daySlots || !daySlots.includes(time)) throw "Slot gone";
          const newDaySlots = daySlots.filter(s=>s !== time);
          slots[date] = newDaySlots;
          tx.update(dref, { slots });
          const bookingRef = db.collection('bookings').doc();
          tx.set(bookingRef, {
            userId: user.uid,
            doctorId: docId,
            date, time, status: "booked",
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        alert("Booked " + date + " " + time);
      } catch (e) {
        console.error("Booking error:", e);
        alert("Booking failed: " + (e.message || e));
      }
    };

    // Doctor: save slots
    const saveSlotsBtn = $('saveSlotsBtn');
    if (saveSlotsBtn) {
      saveSlotsBtn.addEventListener('click', async () => {
        const raw = ($('slotsInput')?.value || '').trim();
        if (!raw) return alert("Enter slots");
        const parts = raw.split(':');
        if (parts.length < 2) return alert("Invalid format. Use date:hh:mm,hh:mm");
        const datePart = parts.shift();
        const times = parts.join(':');
        const timesArr = times.split(',').map(t=>t.trim()).filter(Boolean);
        const user = auth.currentUser;
        if (!user) return alert("Login as a doctor to save slots");
        const udoc = await db.collection('users').doc(user.uid).get();
        const doctorId = udoc.data()?.doctorId;
        if (!doctorId) return alert("Doctor profile not set");
        await db.collection('doctors').doc(doctorId).set({ slots: { [datePart]: timesArr } }, { merge: true });
        alert("Saved slots");
      });
    }

    async function loadDoctorBookings(uid) {
      try {
        const udoc = await db.collection('users').doc(uid).get();
        const docId = udoc.data()?.doctorId;
        if (!docId) return;
        const snap = await db.collection('bookings').where('doctorId','==',docId).get();
        const el = $('doctorBookings');
        el.innerHTML = snap.docs.map(b => {
          const d = b.data();
          return `<div class="card">Patient: ${d.userId} — ${d.date} ${d.time} — ${d.status}</div>`;
        }).join('');
      } catch (e) {
        console.warn("loadDoctorBookings error:", e);
      }
    }

    // ------------ Map: demo + live loader (robust) ------------
    let map;
    function initMap() {
      if (!GOOGLE_MAPS_KEY || GOOGLE_MAPS_KEY === "REPLACE_GOOGLE_MAPS_KEY") {
        showDemoMap();
        return;
      }
      if (window.google && window.google.maps) return initMapOnce();
      const script = document.createElement('script');
      script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_KEY}&libraries=places&callback=initMapOnce`;
      script.async = true;
      script.defer = true;
      script.onerror = () => {
        const mapEl = $('map');
        if (mapEl) mapEl.innerText = "Failed to load Google Maps. Check key and network.";
      };
      document.head.appendChild(script);
    }

    window.initMapOnce = async function() {
      try {
        const mapEl = $('map');
        if (!mapEl) return;
        mapEl.innerHTML = '';
        // get location
        let center;
        try {
          const pos = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(p => resolve(p.coords), err => reject(err), {timeout:10000});
          });
          center = { lat: pos.latitude, lng: pos.longitude };
        } catch (err) {
          console.warn('Geolocation failed or blocked, using fallback location', err);
          center = { lat: 28.6139, lng: 77.2090 }; // fallback
          const fallbackNote = document.createElement('div');
          fallbackNote.style.color = '#666';
          fallbackNote.style.marginBottom = '8px';
          fallbackNote.innerText = 'Using default location (geolocation blocked). Allow location for nearby results.';
          mapEl.appendChild(fallbackNote);
        }

        map = new google.maps.Map(mapEl, { center, zoom: 14, streetViewControl:false, mapTypeControl:false });
        new google.maps.Marker({ position: center, map, title: "You are here", icon: { path: google.maps.SymbolPath.CIRCLE, scale:7, fillColor:'#1565c0', fillOpacity:1, strokeWeight:0 } });

        const service = new google.maps.places.PlacesService(map);

        // create/clear pharmacy list
        let listEl = $('pharmList');
        if (!listEl) {
          listEl = document.createElement('div');
          listEl.id = 'pharmList';
          listEl.style.marginTop = '12px';
          mapEl.parentElement.appendChild(listEl);
        }
        listEl.innerHTML = '<em>Searching nearby pharmacies...</em>';

        service.nearbySearch({ location:center, radius:3000, type: 'pharmacy' }, (results, status) => {
          if (status !== google.maps.places.PlacesServiceStatus.OK || !results || !results.length) {
            listEl.innerHTML = '<div style="color:#666">No nearby pharmacies found.</div>';
            return;
          }
          listEl.innerHTML = '';
          const bounds = new google.maps.LatLngBounds();
          const limited = results.slice(0,20);
          limited.forEach(place => {
            const marker = new google.maps.Marker({ position: place.geometry.location, map, title: place.name });
            bounds.extend(place.geometry.location);

            const item = document.createElement('div');
            item.className = 'doctor';
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.alignItems = 'center';

            const left = document.createElement('div');
            left.style.flex = '1';
            const title = document.createElement('div'); title.style.fontWeight='700'; title.innerText = place.name;
            const vicinity = document.createElement('div'); vicinity.style.fontSize='13px'; vicinity.style.color='#555'; vicinity.innerText = place.vicinity || '';
            const meta = document.createElement('div'); meta.style.fontSize='13px'; meta.style.color='#666'; meta.innerText = (place.rating ? `⭐ ${place.rating} • ` : '') + (place.user_ratings_total ? `${place.user_ratings_total} reviews` : '');
            left.appendChild(title); left.appendChild(vicinity); left.appendChild(meta);

            const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end'; right.style.gap='8px';
            const phoneEl = document.createElement('div'); phoneEl.style.fontSize='13px'; phoneEl.style.color='#0b556b'; phoneEl.innerText='Loading phone...';
            const navLink = document.createElement('a'); navLink.href = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(place.vicinity || place.name)}`; navLink.target='_blank'; navLink.rel='noopener'; navLink.innerText='Navigate'; navLink.style.color='#1565c0'; navLink.style.fontWeight='600';
            right.appendChild(phoneEl); right.appendChild(navLink);

            item.appendChild(left); item.appendChild(right);
            listEl.appendChild(item);

            const infowindow = new google.maps.InfoWindow({ content: `<strong>${place.name}</strong><div style="font-size:13px">${place.vicinity || ''}</div>` });
            marker.addListener('click', () => infowindow.open(map, marker));

            service.getDetails({ placeId: place.place_id, fields: ['formatted_phone_number','opening_hours','website'] }, (det, detStatus) => {
              if (detStatus === google.maps.places.PlacesServiceStatus.OK && det) {
                phoneEl.innerText = det.formatted_phone_number || 'Phone not available';
                if (det.opening_hours) {
                  // opening_hours API differs; be tolerant
                  if (typeof det.opening_hours.isOpen === 'function') {
                    meta.innerText += ` • ${det.opening_hours.isOpen() ? 'Open' : 'Closed'}`;
                  } else if (typeof det.opening_hours.open_now !== 'undefined') {
                    meta.innerText += ` • ${det.opening_hours.open_now ? 'Open' : 'Closed'}`;
                  }
                }
                if (det.website) { navLink.href = det.website; navLink.innerText = 'Website'; }
              } else {
                phoneEl.innerText = 'Phone not available';
              }
            });
          });
          map.fitBounds(bounds);
          if (limited.length === 1) map.setZoom(15);
        });

      } catch (err) {
        console.error('initMapOnce error', err);
        const mapEl = $('map');
        if (mapEl) mapEl.innerText = "Could not load location. Allow location permission or try later.";
      }
    };

    // Demo fallback rendering
    function showDemoMap(){
      const mapEl = $('map');
      if (!mapEl) return;
      mapEl.innerHTML = '';
      const wrap = document.createElement('div');
      wrap.style.position='relative';
      wrap.style.borderRadius = getComputedStyle(mapEl).borderRadius || '8px';
      wrap.style.overflow='hidden';
      wrap.style.minHeight='260px';
      wrap.style.display='flex';
      wrap.style.alignItems='center';
      wrap.style.justifyContent='center';
      wrap.style.background='linear-gradient(180deg,#e9f2ff,#f8fbff)';

      const svg = `<svg width="100%" height="320" viewBox="0 0 1200 400" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid slice"><defs><linearGradient id="g1" x1="0" x2="0" y1="0" y2="1"><stop offset="0" stop-color="#dbeeff"/><stop offset="1" stop-color="#f8fbff"/></linearGradient></defs><rect width="100%" height="100%" fill="url(#g1)"/><g stroke="#cde4ff" stroke-width="18" stroke-linecap="round" stroke-linejoin="round" fill="none" opacity="0.95"><path d="M40 300 C 180 220, 320 330, 460 260 S 740 190, 900 250" /><path d="M60 190 C 220 120, 400 180, 600 140 S 980 80, 1140 120" /></g><g fill="#fff" opacity="0.9"><rect x="80" y="60" width="120" height="80" rx="8"/><rect x="280" y="120" width="140" height="100" rx="10"/><rect x="520" y="70" width="180" height="120" rx="12"/><rect x="840" y="130" width="160" height="90" rx="10"/></g><g fill="#e53935"><g transform="translate(160,210)"><path d="M12 0 C 5.4 0 0 5.4 0 12 C 0 22 12 36 12 36 C 12 36 24 22 24 12 C24 5.4 18.6 0 12 0 Z"/><circle cx="12" cy="12" r="5" fill="#fff"/></g><g transform="translate(560,160)"><path d="M12 0 C 5.4 0 0 5.4 0 12 C 0 22 12 36 12 36 C 12 36 24 22 24 12 C24 5.4 18.6 0 12 0 Z"/><circle cx="12" cy="12" r="5" fill="#fff"/></g><g transform="translate(980,220)"><path d="M12 0 C 5.4 0 0 5.4 0 12 C 0 22 12 36 12 36 C 12 36 24 22 24 12 C24 5.4 18.6 0 12 0 Z"/><circle cx="12" cy="12" r="5" fill="#fff"/></g></g><g transform="translate(40,330)" fill="#0f1724" font-family="Inter,Arial" font-size="18"><text x="0" y="0">Nearby pharmacies (demo)</text></g></svg>`;

      const svgWrap = document.createElement('div');
      svgWrap.style.width='100%';
      svgWrap.style.padding='12px';
      svgWrap.innerHTML = svg;

      const control = document.createElement('div');
      control.style.position='absolute';
      control.style.right='12px';
      control.style.top='12px';
      control.style.zIndex='20';
      control.style.display='flex';
      control.style.gap='8px';
      control.style.alignItems='center';

      const liveBtn = document.createElement('button');
      liveBtn.textContent = 'Load live map';
      liveBtn.style.background = '#1565c0';
      liveBtn.style.color = 'white';
      liveBtn.style.border = 'none';
      liveBtn.style.padding = '8px 10px';
      liveBtn.style.borderRadius = '8px';
      liveBtn.style.cursor = 'pointer';
      liveBtn.onclick = () => {
        if (!GOOGLE_MAPS_KEY || GOOGLE_MAPS_KEY === "REPLACE_GOOGLE_MAPS_KEY") {
          alert('No Google Maps key found. Set GOOGLE_MAPS_KEY to load live map.');
          return;
        }
        initMap();
      };

      const info = document.createElement('div');
      info.style.background = 'rgba(255,255,255,0.9)';
      info.style.padding = '8px 10px';
      info.style.borderRadius = '8px';
      info.style.fontSize = '13px';
      info.style.color = '#0f1724';
      info.textContent = 'Demo mode';

      control.appendChild(info);
      control.appendChild(liveBtn);

      wrap.appendChild(svgWrap);
      wrap.appendChild(control);
      mapEl.appendChild(wrap);
    }
    // ------------ End Map code ------------

  </script>
</body>
</html>
